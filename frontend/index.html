<!DOCTYPE html>
<html>
<head>
  <title>AI Chatbot</title>
</head>
<body>
  <h2>Login / Regisztr√°ci√≥</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Jelsz√≥"><br>
  <button onclick="register()">Regisztr√°ci√≥</button>
  <button onclick="login()">Bel√©p√©s</button>

  <h2>Profil ‚Äì Tud√°sb√°zis</h2>
  <h2>El≈ëfizet√©s</h2>
  <select id="tier">
    <option value="basic">$20 / h√≥ ‚Äì Alap</option>
    <option value="pro">$50 / h√≥ ‚Äì Pro</option>
    <option value="vip">$100 / h√≥ ‚Äì VIP</option>
  </select>
  <button onclick="startSubscription()">El≈ëfizet√©s ind√≠t√°sa</button>
  <p id="substatus"><strong>El≈ëfizet√©s st√°tusz:</strong> ...</p>
  <p><strong>El≈ëfizet√©si csomagod:</strong> <span id="usertier">‚Äì</span></p>
  <button onclick="loadProfile()">Bet√∂lt√©s</button><br>
  <textarea id="kb" style="width: 100%; height: 100px;"></textarea><br>
  <button onclick="saveProfile()">Ment√©s</button>
  <pre id="kbmsg"></pre>

  <h2>Chatbot profil kiv√°laszt√°sa</h2>
  <select id="chatprofile" onchange="updateProfile()">
    <option value="support">√úgyf√©lszolg√°lat</option>
    <option value="marketing">Marketing</option>
    <option value="education">Oktat√°s</option>
  </select>
  <p id="profilemsg"></p>


  <h2>Chat</h2>
  <textarea id="msg" placeholder="√çrd be a k√©rd√©sed..."></textarea><br>
  <button onclick="send()">K√ºld√©s</button>
  <pre id="out"></pre>

  <script>
    async function register() {
      const res = await fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email: document.getElementById('email').value,
          password: document.getElementById('password').value
        })
      });
      const data = await res.json();
      alert(data.message || 'Sikeres regisztr√°ci√≥!');
    }

    async function login() {
      const res = await fetch('/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email: document.getElementById('email').value,
          password: document.getElementById('password').value
        })
      });
      const data = await res.json();
      if (data.access_token) {
        localStorage.setItem('token', data.access_token);
        alert("Sikeres bel√©p√©s!");
      } else {
        alert("Hiba a bel√©p√©sn√©l.");
      }
    }

    async function send() {
      const token = localStorage.getItem('token');
      const res = await fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          user_id: document.getElementById('email').value,
          message: document.getElementById('msg').value
        })
      });
      const data = await res.json();
      document.getElementById('out').innerText = data.response || data.detail || "Nincs v√°lasz.";
    }

    'tud√°sb√°zis szerkeszt√©se'
    async function loadProfile() {
      const token = localStorage.getItem('token');
      const email = document.getElementById('email').value;

      const res = await fetch(`/user/${email}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })

      document.getElementById('usertier').innerText = data.tier || "‚Äì";
      ;

      const data = await res.json();

      document.getElementById('kb').value = data.knowledge_base || "";
      document.getElementById('substatus').innerHTML = data.subscription_active
        ? "<strong>El≈ëfizet√©s st√°tusz:</strong> ‚úÖ Akt√≠v"
        : "<strong>El≈ëfizet√©s st√°tusz:</strong> ‚õî Nem akt√≠v";
    }


    async function saveProfile() {
      const token = localStorage.getItem('token');
      const email = document.getElementById('email').value;
      const knowledge = document.getElementById('kb').value;

      const res = await fetch(`/user/${email}/knowledge`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(knowledge)
      });

      const data = await res.json();
      document.getElementById('kbmsg').innerText = data.message || "Sikeres ment√©s!";
    }

    async function startSubscription() {
      const email = document.getElementById('email').value;
      const tier = document.getElementById('tier').value;

      if (!email) return alert("El≈ëbb add meg az e-mail c√≠med!");

      const res = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, tier })
      });

      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert("Hiba: " + (data.error || "nem siker√ºlt elind√≠tani a fizet√©st"));
      }
    }
  </script>

<h2>Admin Panel</h2>
<button onclick="loadUsers()">Felhaszn√°l√≥k bet√∂lt√©se</button>
<div id="userlist"></div>
<h2>Admin Statisztika</h2>
<button onclick="loadStats()">Statisztika friss√≠t√©se</button>
<pre id="statsout"></pre>

<h3>Napi k√©rd√©sek statisztika</h3>
<button onclick="loadQuestionStats()">Napi k√©rd√©sek lek√©r√©se</button>
<pre id="daystats"></pre>

<h3>Chatnapl√≥ export</h3>
<a href="/admin/chatlog/export" target="_blank">üì• CSV let√∂lt√©s</a>

  <script>
  async function loadUsers() {
    const token = localStorage.getItem('token');
    const res = await fetch('/admin/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const users = await res.json();
    let html = "<ul>";
    users.forEach(u => {
      html += `<li>${u.id} ‚Äì ${u.subscription_active ? '‚úÖ akt√≠v' : '‚ùå inakt√≠v'} 
        <button onclick="activate('${u.id}')">Aktiv√°l√°s</button></li>`;
    });
    html += "</ul>";
    document.getElementById('userlist').innerHTML = html;
  }

  async function activate(id) {
    const token = localStorage.getItem('token');
    const res = await fetch(`/admin/users/${id}/activate`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    alert(data.message);
    loadUsers();
  }

  async function loadStats() {
    const token = localStorage.getItem('token');
    const res = await fetch('/admin/stats', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    document.getElementById('statsout').innerText = `
    Felhaszn√°l√≥k sz√°ma: ${data.total_users}
    Akt√≠v el≈ëfizet√©sek: ${data.active_subscriptions}`;
  }

  async function updateProfile() {
  const token = localStorage.getItem('token');
  const email = document.getElementById('email').value;
  const profile = document.getElementById('chatprofile').value;

  const res = await fetch(`/user/${email}/profile`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ profile })
  });

  const data = await res.json();
  document.getElementById('profilemsg').innerText = data.message || "Profil friss√≠tve!";
}

async function loadQuestionStats() {
  const token = localStorage.getItem('token');
  const res = await fetch('/admin/stats/questions-per-day', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const stats = await res.json();
  let text = "üóì Napi k√©rd√©sek:\n\n";
  stats.forEach(row => {
    text += `${row.day}: ${row.count} db\n`;
  });
  document.getElementById('daystats').innerText = text;
}

  </script>

</body>
</html>
